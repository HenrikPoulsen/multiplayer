unity_versions:
# Make sure you update update-editor-revisions: dependencies when you change this
- 2019.1
- 2019.2
- 2019.3
standard_platforms:
- name: windows
  agent:
    type: Unity::VM
    image: sdet/gamecode_win10:stable
    flavor: b1.large
  bindings_build: build.bat
  setup_tools:
  - wget -O beforescript.py https://artifactory.eu-cph-1.unityops.net/core-automation/tools/scripts/beforescript.py
  - wget -O utils.py https://artifactory.eu-cph-1.unityops.net/core-automation/tools/scripts/utils.py
- name: macOS
  agent:
    type: Unity::VM::osx
    image: buildfarm/mac:stable
    flavor: m1.mac
  bindings_build: make && make install
  setup_tools:
  - curl https://artifactory.eu-cph-1.unityops.net/core-automation/tools/scripts/beforescript.py -o beforescript.py
  - curl https://artifactory.eu-cph-1.unityops.net/core-automation/tools/scripts/utils.py -o utils.py
unity_launcher:
  windows: powershell.exe utr/utr --artifacts_path=artifacts
  macOS: sh ./utr/utr --artifacts_path=artifacts

---

{% for version in unity_versions %}

validation:{{ version }}:
  name: Validation {{ version }}
  agent:
    type: Unity::VM
    image: 'package-ci/ubuntu:v1.0.4-259354'
    flavor: b1.small
  commands:
  - sudo pip install unity-downloader-cli --extra-index-url https://artifactory.eu-cph-1.unityops.net/api/pypi/common-python/simple
  - curl https://artifactory.eu-cph-1.unityops.net/core-automation/tools/scripts/utils.py -o utils.py
  - curl https://artifactory.eu-cph-1.unityops.net/core-automation/tools/scripts/validation.py -o validation.py
  - python validation.py --build-version {{ version }} --package-path com.unity.transport
  artifacts:
    revisions:
      paths:
      - "*_revision.txt"

{% endfor %} # unity_versions

{% for platform in standard_platforms %}
{{ platform.name }}:build-bindings:build:
  name: Build bindings {{ platform.name }}
  agent:
    type: {{ platform.agent.type }}
    image: {{ platform.agent.image }}
    flavor: {{ platform.agent.flavor }}
  commands:
  - cd network.bindings && {{ platform.bindings_build }}

  artifacts:
    logs:
      paths:
      - "com.unity.transport/Runtime/Bindings/**"
{% for version in unity_versions %}

{{ platform.name }}:{{ version }}:test:
  name: Editor tests {{ platform.name }} {{ version }}
  agent:
    type: {{ platform.agent.type }}
    image: {{ platform.agent.image }}
    flavor: {{ platform.agent.flavor }}
  commands:
    {% for tool in platform.setup_tools %}
    - {{ tool }}
    {% endfor %}
    - pip install unity-downloader-cli --extra-index-url https://artifactory.eu-cph-1.unityops.net/api/pypi/common-python/simple
    - python beforescript.py Editor
    - {{ unity_launcher[platform.name] }} --timeout 1200 --editor-location=.Editor --testproject=sampleproject --suite=editor --suite=playmode
  artifacts:
    logs:
      paths:
      - "artifacts/**/*"
  dependencies:
  - .yamato/ci.yml#validation:{{ version }}
  - .yamato/ci.yml#{{ platform.name }}:build-bindings:build


#TODO: Add standalone playmode

{% endfor %} # unity_versions
{% endfor %} # standard_platforms

package:pack:
  name: Package Pack
  agent:
    type: Unity::VM
    image: 'package-ci/ubuntu:v1.0.4-259354'
    flavor: b1.small
  commands:
  - npm config set prefix '~/npm-global'
  - npm install upm-ci-utils@stable -g --registry https://api.bintray.com/npm/unity/unity-npm
  - ~/npm-global/bin/upm-ci package pack --package-path com.unity.transport
  artifacts:
    package:
      paths:
      - "upm-ci~/packages/**/*"
  dependencies:
    {% for platform in standard_platforms %}
    - .yamato/ci.yml#{{ platform.name }}:build-bindings:build
    {% endfor %} # standard_platforms

ci:
  name: Run CI
  agent:
    type: Unity::VM
    image: 'package-ci/ubuntu:v1.0.4-259354'
    flavor: b1.small
  dependencies:
  {% for version in unity_versions %}
  {% for platform in standard_platforms %}
  - .yamato/ci.yml#{{ platform.name }}:{{ version }}:test
  {% endfor %} # standard_platforms
  {% endfor %} # version
  - .yamato/ci.yml#package:pack
  triggers:
    branches:
      only:
      - /.*/
      except: []